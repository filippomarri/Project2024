<html>
    <head></head>
    <body>
        <div id="container">
            <h1>Scriabin's Chromesthesia</h1>
            <p>Drag and Drop and image, paste it, or use the upload bar below</p>
            <div>
                <input id="getfile" type="file" />
                <label for="getfile">Upload an image</label>
            </div>
            <div id="imagecontainer"></div>
            <output></output>
        </div>

        <style>
            html, body {
                height: 100%;
                display: block;
                margin: 0;
                padding: 0;
                font-family: Arial, Helvetica, sans-serif;
            }
            h1 {
                margin: 0;
                padding: 10px 0;
            }
            #container {
                height: 100%;
                padding: 0 20px;
                display: block;
                background: honeydew;
                }
            label {
                display: block;
                padding: 5px 10px;
                background: seagreen;
            }
            [type="file"] {
                border: 0;
                clip: rect(0, 0, 0, 0);
                height: 1px;
                overflow: hidden;
                padding: 0;
                position: absolute !important;
                white-space: nowrap;
                width: 1px;
            }
            [type="file"]:focus + label,
            [type="file"] + label:hover {
                background-color: green;
                display: block;
            }
            [type="file"]:focus + label {
                outline: 1px dotted #000;
            }  
            output {
                display: block;
                padding: 5px 10px;
            }
        </style>

        <script>
            function upload_image(){
                const fileinput = document.querySelector('#getfile');  //The Document method querySelector() returns the first Element within the document that matches the specified selector, or group of selectors.
                const output = document.querySelector('output');
                const imagecontainer = document.querySelector('#imagecontainer');
                const pickercontainer = document.querySelector('#pickercontainer');
                const colourpicker = document.querySelector('#pickcolour'); //It grabs the colour picker (the instrumnet that pick a colour from the image)
                colourpicker.setAttribute('list','presets'); //It dinamically adds a list attribute to the colour picker

                const datalist = document.createElement('datalist'); //It creates a datalist with the preset id and it add it to the container
                datalist.setAttribute('id','presets');
                pickercontainer.appendChild(datalist);

                /* Show the image once we have it */
                const loadImage = (file, name) => {
                    if (name) {
                        output.innerText = 'Filename: ' + name;
                    }
                    var img = new Image();
                    img.src = file; //the source is the file
                    img.onload = function() {
                        imagecontainer.appendChild(img);  //calls the function to show the image
                        analyseColours(img); //calls the function to analise it
                    };
                }
 
                /* Image from Clipboard */
                const getClipboardImage = (ev) => {
                    let items = ev.clipboardData.items;
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            var blob = items[i].getAsFile();
                            loadImage(window.URL.createObjectURL(blob));
                            break;
                        }
                    }
                }
                window.addEventListener('paste', getClipboardImage, false);

                /* Image from Drag and Drop */
                const imageFromDrop = (e) => {
                    var file = e.dataTransfer.files[0];
                    loadImage(window.URL.createObjectURL(file), file.name);
                    e.preventDefault();
                }
                container.addEventListener('drop', imageFromDrop, false);
                // Overwrite the normal drag and drop behaviour
                container.addEventListener('dragover', (ev) => {
                    ev.preventDefault();
                }, false);

                /* Image from Upload */
                const imageFromUpload = (e) => {
                    var file = e.target.files[0];
                    loadImage(window.URL.createObjectURL(file), file.name);
                    e.preventDefault();
                }
                fileinput.addEventListener('change', imageFromUpload, false);

                /*we create a worker in order to analyse the image not on the main thread*/
                let worker = new Worker(imagecolouranalyser); //the worker allows us not to have interferences on the interface
                
                worker.addEventListener('message', (e) => { // once he worker is done, send its data to addToColourPicker
                    addToColourPicker(e.data);
                }, false);

                worker.addEventListener('error', (e) => { // It shows eventual errors in the console log
                    console.log('worker error', e);
                }, false);

                /*It creates a new canvas, it resize it and it send it to the worker*/
                const analyseColours = (img) => {
                    let c = document.createElement('canvas');
                    let cx = c.getContext('2d');
                    let w = img.naturalWidth;
                    let h = img.naturalHeight;
                    c.width = w;
                    c.height = h;
                    cx.drawImage(img, 0,0);
                    let pixels = cx.getImageData(0, 0, w, h).data;
                    worker.postMessage(pixels); //it posts the image to the worker
                }

                const addToColourPicker = (colours) => {
                    let out = '';
                    colours.forEach(c => {
                        out += `<option value="#${c}"></option>`
                    });
                    datalist.innerHTML = out;
                    colourpicker.click();
                }

                /*core of the anyliser*/
                function imagecolouranalyser(){
                    const process = (e) => {
                        var data = e.data;
                        let all = data.length;
                        let coloursused = new Set();
                        for (i = 0; i < all; i += 4) {
                            let hex = ''+ rgbToHex(data[i]) + rgbToHex(data[i+1]) + rgbToHex(data[i+2]);        
                            coloursused.add(hex);
                        }
                        postMessage(coloursused);
                    }
                    const rgbToHex = (col) => { //it transform a colour in the corrispondent hexadecimal code
                        return parseInt(col,10).toString(16);
                    }
                    addEventListener('message', process, false);
                }
            }
            upload_image(); //it "calls" the program
        </script>
    </body>
</html>